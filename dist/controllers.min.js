/*
 bmbase 2016-05-22 
*/
!function(){function a(a,b,c,d){var e=this;e.id=Number(a.id);var f,g,h,i,j,k=_.filter(d.getFieldInfo(),{id:e.id})[0].data,l=300,m=800,n=200,o=30,p=20,q=40,r=20,s=5,t=20,u=m-n-p;e.loading=!0,e.totalWidth=m,b({method:"GET",url:"https://api.solvebio.com/v1/datasets/"+e.id+"?access_token="+c.accessToken}).then(function(a){e.description=a.data.description,e.depository=a.data.depository}),b({method:"GET",url:"https://api.solvebio.com/v1/datasets/"+e.id+"/fields?access_token="+c.accessToken+"&limit=10000"}).then(function(a){e.fields=a.data.data,e.fields.forEach(function(a){a.properName=d.proper(a.name),a.graphicType=k[a.name]})}),b({method:"GET",url:"https://api.solvebio.com/v1/datasets/"+e.id+"/data?access_token="+c.accessToken+"&limit=10000"}).then(function(a){e.data=a.data.results,f=e.data.length*(t+s)+s,g=f+q+r,e.totalHeight=g,d3.selectAll(".chartHolder").append("rect").attr("x",n).attr("y",q).attr("width",u).attr("height",f).classed("chartOutline",!0),t=(f-(e.data.length+1)*s)/e.data.length,j=d3.scale.ordinal().domain(d3.range(e.data.length)).rangeRoundBands([0,f]),h=d3.selectAll(".chartHolder").selectAll(".g").data(e.data).enter().append("g").attr("transform",function(a,b){return"translate("+n+","+(j(b)+q+s)+")"});var b=_.findKey(k,function(a){return"name"==a}),c=[];_.filter(k,function(a,b){"description"==a&&c.push(b)}),h.append("rect").classed("bar",!0).attr("height",t).attr("width",0).on("click",function(a,e){var f="";f+="<strong>"+d.proper(b)+":</strong> "+a[b]+"<br>",c.forEach(function(b,c){f+="<strong>"+d.proper(b)+":</strong> "+a[b]+"<br>"}),$("#dataDetail").css("opacity",.9).css("z-index",1).css("top",event.pageY).css("left",event.pageX).find(".detailLabel").html(f)}),h.append("text").text(function(a,c){return a[b].length>o?a[b].slice(0,o)+"...":a[b]}).classed("label",!0).attr("x",-n).attr("y",(t+s)/2),h.append("path").attr("d","M "+-n+","+(t+s/2)+" L"+.725*m+","+(t+s/2)+" Z"),h.append("text").classed("value",!0),d3.selectAll(".chartHolder").append("g").attr("transform",function(){return"translate("+n+","+q+")"}).attr("class","x-axis axis"),e.loading=!1}),e.summaryStatistics=!1,e.selectField=function(a){e.summaryStatistics=!0,i=a,e.fieldName=d.proper(i);var b=e.data.map(function(a){return Number(a[i])});e.fieldCount=b.length,e.fieldAverage=_.reduce(b,function(a,b){return a+b},0)/e.data.length,e.fieldMax=d3.max(b),e.fieldMin=d3.min(b);var c=d3.scale.linear().domain([0,d3.max(e.data.map(function(a){return Number(a[i])}))]).range([0,u-40]),f=d3.svg.axis().scale(c).orient("top"),g=d3.scale.linear().domain([0,d3.max(e.data.map(function(a){return Number(a[i])}))]).range(["lightgreen","darkblue","blue","purple"]);h.selectAll(".bar").transition().duration(3*l).attr("width",function(a){return c(Number(a[i]))}).attr("fill",function(a,b){return g(Number(a[i]))}),d3.selectAll(".value").text(function(a){return Number(a[i]).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}).attr("x",function(a){return c(Number(a[i]))+10}).attr("y",(t+s)/2).classed("label",!0),d3.selectAll(".x-axis").call(f)},e.closeDetailLabel=function(){$("#dataDetail").css("opacity",0).css("z-index",-1)};var v=!0,w=function(a,b){return v?a[i]-b[i]:b[i]-a[i]};e.sortBars=function(){v=!v,h.sort(w).transition().duration(l).attr("transform",function(a,b){return"translate("+n+","+(j(b)+q+s)+")"})}}angular.module("app").controller("DatasetCtrl",["$routeParams","$http","ENV","Utils",a])}(),function(){function a(a,b,c){var d=this,e=c.getFieldInfo().map(function(a){return a.id});b({method:"GET",url:"https://api.solvebio.com/v1/datasets?access_token="+a.accessToken+"&limit=100"}).then(function(a){d.datasets=a.data.data.filter(function(a){return-1!=e.indexOf(a.id)})})}angular.module("app").controller("MainCtrl",["ENV","$http","Utils",a])}(),function(){function a(){var a=this;a.teammates=[{id:1,first:"Sam",last:"Stone",city:"Boston"},{id:2,first:"Midori",last:"Uehara",city:"Boston"},{id:3,first:"Dan",last:"Settel",city:"LA"}]}angular.module("app").controller("TeamCtrl",[a])}(),function(){function a(a,b,c){var d=this;d.id=b.id,d.first=b.f,d.last=b.l,d.test="Hello world"}angular.module("app").controller("TeammateCtrl",["$route","$routeParams","$location",a])}();